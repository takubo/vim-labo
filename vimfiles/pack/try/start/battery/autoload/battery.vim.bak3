vim9script
# vim: set ts=8 sts=2 sw=2 tw=0 et:
scriptencoding utf-8



#----------------------------------------------------------------------------------------
# Constants

# TODO
if !exists('ACStatus')
export enum ACStatus
  Unknown,
  NotConnected,
  NotCharging,
  Charging,
endenum
endif

const ACStatusStr = [
 #ACStatus.Unknown.ordinal:      'â”',
 #ACStatus.NotConnected.ordinal: 'ğŸ”‹',
 #ACStatus.NotCharging.ordinal:  'ğŸ”Œ',
 #ACStatus.Charging.ordinal:     'âš¡',
]


const ACStatusEmoji = [
  'â”',
  'ğŸ”‹',
  'ğŸ”Œ',
  'âš¡',
]


const ACStatusChar = [
  '?',
  '@',
  '#',
  '$',
]



#----------------------------------------------------------------------------------------
# API

export def g:GetBatteryInfo(): dict<any>
  return BatteryInfo
enddef

export def g:GetBatteryInfoStr(): string
  return BatteryInfoStr
enddef

export def g:GetBatteryPercent(): number
  return BatteryInfo.RemainingPercent
enddef



#----------------------------------------------------------------------------------------
# æ›´æ–°

import autoload 'util_func.vim' as uf

def Update(dummy: number)
  if false
    # TODO battery_dummy.vim
  else
    SystemUpdateFunc(BatteryInfo)
  endif

  # æ®‹ã‚Šæ™‚é–“ã®æ–‡å­—åˆ—è¡¨ç¾ (HH:MM:SS)
  BatteryInfo.RemainingTimeFormatedStr = BatteryInfo.RemainingTimeSecond >= 0 ?
                                         uf.TimeFormat_Sec2Str(BatteryInfo.RemainingTimeSecond) :
                                         '--:--:--'

  BatteryInfo.ACStatusEmoji = ACStatusEmoji[BatteryInfo.ACStatus.ordinal]  # é›»æºã¸ã®æ¥ç¶šçŠ¶æ…‹ã®çµµæ–‡å­—è¡¨ç¾
  BatteryInfo.ACStatusChar  = ACStatusChar[BatteryInfo.ACStatus.ordinal]   # é›»æºã¸ã®æ¥ç¶šçŠ¶æ…‹ã®ASCIIæ–‡å­—è¡¨ç¾

 #'FullTimeFormatedStr':       '--:--:--',        # æº€å……é›»æ™‚ã®ä½¿ç”¨å¯èƒ½æ™‚é–“ã®æ–‡å­—åˆ—è¡¨ç¾ (HH:MM:SS)
 #'NeedTimeFormatedStr':       '--:--:--',        # æº€å……é›»ã¾ã§ã®æ™‚é–“ã®æ–‡å­—åˆ—è¡¨ç¾ (HH:MM:SS)
 #'ACPlugedStatusEmoji':       Unknown,
 #'ChargingStatusEmoji':       Unknown,
 #'RemainingPercentStr':       printf('%3d%%', RemainingPercent),

  # BatteryInfoStr = 'â” ---% [--:--:--]'
  #                  'ğŸ”‹  35% [ 2:04:43]'
  #                  'ğŸ”Œ 100% [10:04:43]'
  BatteryInfoStr = printf('%s %3d% [%8s]',
                           BatteryInfo.ACStatusEmoji,
                           BatteryInfo.RemainingPercent,
                           BatteryInfo.RemainingTimeFormatedStr
                         )

  # Callback
  doautocmd User BatteryInfoUpdate
enddef


var Dummy = 0
augroup BatteryDummy
  au!
  au User BatteryInfoUpdate Dummy = 0
augroup end



#----------------------------------------------------------------------------------------
# åˆæœŸåŒ–


#--------------------------------------------
# Variables

var BatteryInfo = {
  'RemainingPercent':          0,                 # æ®‹ã‚Šãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆ
  'RemainingTimeSecond':       0,                 # æ®‹ã‚Šç§’æ•°
  'RemainingTimeFormatedStr':  '--:--:--',        # æ®‹ã‚Šæ™‚é–“ã®æ–‡å­—åˆ—è¡¨ç¾ (HH:MM:SS)
 #'FullTimeSecond':            0,                 # æº€å……é›»æ™‚ã®ä½¿ç”¨å¯èƒ½ç§’æ•°
 #'FullTimeFormatedStr':       '--:--:--',        # æº€å……é›»æ™‚ã®ä½¿ç”¨å¯èƒ½æ™‚é–“ã®æ–‡å­—åˆ—è¡¨ç¾ (HH:MM:SS)
 #'NeedTimeSecond':            0,                 # æº€å……é›»ã¾ã§ã®ç§’æ•°
 #'NeedTimeFormatedStr':       '--:--:--',        # æº€å……é›»ã¾ã§ã®æ™‚é–“ã®æ–‡å­—åˆ—è¡¨ç¾ (HH:MM:SS)
  'ACStatus':                  ACStatus.Unknown,  # é›»æºã¸ã®æ¥ç¶šçŠ¶æ…‹ (ä¸æ˜ / éæ¥ç¶š / æ¥ç¶š&éå……é›» / å……é›»ä¸­ )
  'ACStatusEmoji':             'â”',              # é›»æºã¸ã®æ¥ç¶šçŠ¶æ…‹ã®çµµæ–‡å­—è¡¨ç¾
  'ACStatusChar':              '?',               # é›»æºã¸ã®æ¥ç¶šçŠ¶æ…‹ã®ASCIIæ–‡å­—è¡¨ç¾
 #'ACPlugedStatus':            Unknown,
 #'ChargingStatus':            Unknown,
 #'ACPlugedStatusEmoji':       Unknown,
 #'ChargingStatusEmoji':       Unknown,
 #'SaverMode':                 Unknown,
 #'RemainingPercentStr':       printf('%3d%%', RemainingPercent),
}

var BatteryInfoStr = 'â” ---% [--:--:--]'
#                    '? ---% [--:--:--]'


#--------------------------------------------
# ã‚·ã‚¹ãƒ†ãƒ é¸æŠ

if exists('g:BatteryNet') && g:BatteryNet
  import autoload 'net/battery_sys_net.vim' as sys
elseif has('osxdarwin')
  import autoload 'osx/battery_sys_osx.vim' as sys
elseif has('win32')
  import autoload 'dos/battery_sys_dos.vim' as sys
else
  import autoload 'dos/battery_sys_unsupported.vim' as sys
endif


#--------------------------------------------
# é…å»¶åˆæœŸåŒ–

def Init(dummy: number)
  if sys.Init()
    SystemUpdateFunc(dummy)
    timer_start(15000, Update, {'repeat': -1})
  endif
enddef

timer_start(3000, Init)
